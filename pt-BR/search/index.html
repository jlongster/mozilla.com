<?php
    // The $body_* variables are for compatibility with pre-existing css
    $page_title = 'Resultados da Busca em Mozilla.com';
    $body_id    = 'search';
    $extra_headers = <<<EXTRA_HEADERS
    <link rel="stylesheet" type="text/css" href="{$config['static_prefix']}/style/covehead/search.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="/includes/nutch-interface/style/moz_nutch.css" media="screen" />
EXTRA_HEADERS;
    require_once "{$config['file_root']}/includes/l10n/controller.inc.php";
    require_once "{$config['file_root']}/{$lang}/includes/header.inc.php";

    // Include the nutch interface library
    require_once "{$config['file_root']}/includes/nutch-interface/mozNutch.class.php";

    if (!empty($config['nutch_url'])) {

        $_query = '';

        if (array_key_exists('hits_per_page', $_GET) && ctype_digit($_GET['hits_per_page'])) {
            $_hits_per_page = $_GET['hits_per_page'];
        } else {
            $_hits_per_page = 10;
        }

        $_hits_per_page = ($_hits_per_page > 50) ? 50 : $_hits_per_page; // hard limit

        if (array_key_exists('start', $_GET) && ctype_digit($_GET['start'])) {
            $_start = $_GET['start'];
        } else {
            $_start = 0;
        }

        $_hits_per_site = 0; // Manually override.  This is always zero.

        if (array_key_exists('query', $_GET)) {

            try {

                $nutch = new mozNutch($config['nutch_url']);

                // Add L10n to the search button format
                $nutch->nav_area = '<div class="pages"><table><tr><td class="searchlabel">'.___('Resultados').'</td>NAV_CONTENT</tr></table></div>';

                // Restrict results to mozilla.com
                $nutch->server_name = $config['nutch_server_name'];

                $results = $nutch->query($_GET['query'], $_hits_per_page, $_start);

                $result = $nutch->transformXmlToHtml($results);

            } catch (Exception $e) {

                //$error = $e->getMessage();
                $error = ___('Nenhum resultado encontrado.'); // Keep it simple

            }

            $_query = htmlspecialchars($_GET['query']);
        }
    }
?>


<div id="main-feature">

	<h2>Mozilla.com - Busca</h2>

	<form id="moz_global_search_body" action="" method="get"><div>
		<input type="text" name="query" id="query_body" value="<?=$_query?>" />
		<input type="hidden" name="hits_per_page" id="hits_per_page_body" value="<?=$_hits_per_page?>" />
		<input type="hidden" name="hits_per_site" id="hits_per_site_body" value="<?=$_hits_per_site?>" />
		<input type="submit" id="submit_body" value="<?=___('Buscar');?>" />
	</div></form>

</div>

<div id="content">

        <?php
        // @todo surround these two blocks with appropriate tags.  sgarrity?
            if (isset($error)) {
                echo $error;
            }

            if (isset($result)) {
                echo $result;

                $_options  = array(
                    'query'       => $_GET['query'],
                    'start'       => $nutch->getStartIndexFromXml($results),
                    'total'       => $nutch->getTotalResultsFromXml($results),
                    'hitsPerPage' => $_hits_per_page,
                    'hitsPerSite' => $_hits_per_site
                );

                echo $nutch->getNavigation($_options);
            }
        ?>

</div><!-- end #content div -->

<!-- Please do not ever remove this comment. -->

<?php
  require_once $footerfile;
?>
