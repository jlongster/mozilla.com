<?php
    // The $body_* variables are for compatibility with pre-existing css
    $page_title = 'Firefox Future Releases';
    $body_id    = 'channel';
    require_once "{$config['file_root']}/includes/regions.php";
    require_once "{$config['file_root']}/includes/email/forms.php";

    $form = new ChannelsForm(array('AURORA', 'FIREFOX_BETA_NEWS', 'MOZILLA_AND_YOU'), $_POST);
    $status = '';
    if ($form->save()) {
        $status = 'success';
    } elseif ($form->error) {
        $status = 'error error-'. $form->error;
    }
    
    $extra_headers = <<<EXTRA_HEADERS
    <link rel="stylesheet" href="{$config['static_prefix']}/style/covehead/channel.css" media="screen" />
EXTRA_HEADERS;
    include_once "{$config['file_root']}/{$lang}/includes/header.inc.php";

?>

<div id="main-feature">
    <h2>Welcome to the<span>Future of Firefox</span></h2>
    <p>Download and test the build that’s right for you, and sign up for a channel newsletter to stay in the loop.</p>
</div>

<div id="main-content">

    <div id="download_aurora" class="channel">
        <h3><span>Aurora</span></h3>
        <ul class="channel-list">
            <li>Experience the newest innovations before they go to beta in an environment that’s not for the faint of heart</li>
            <li>Provide feedback on features and performance to help determine what makes the final release</li>
        </ul>
        <div id="download_aurora_button">
            <script><?php include $config['file_root'] . '/js/download.old.js';?></script>
            <script>
                <!--
                // Configure the Firefox download write script
                var gDownloadTracker = "";
                var gDownloadItemTemplate = " <li class=\"%CSS_CLASS%\"> <a href=\"%BOUNCER_URL%\" class=\"download-link download-firefox\"><span class=\"download-content\"><span class=\"download-title\">Download</span> Mozilla Firefox Aurora <\/span><\/a> <\/li>";
                var gDownloadItemMacOS9 = "<a href=\"\">MacOS 9 and earlier are not supported<\/a>";
                var gDownloadItemOtherPlatform = "<a href=\"/<?=$lang?>/firefox/<?=LATEST_FIREFOX_VERSION?>/releasenotes/#contributedbuilds\" onclick=\"" + gDownloadTracker + "\">Free Download<\/a>"

                document.writeln("<ul class=\"home-download " + gCssClass + " \">");
                writeDownloadItems("fxaurora");
                document.writeln("<\/ul>");
                document.writeln("<div class=\"download-other\">");
                document.writeln("<a href=\"\/<?=$lang?>\/firefox\/all-aurora.html\">All Systems &amp; Languages<\/a> | ");
                document.writeln("<a href=\"\/<?=$lang?>\/legal\/privacy\/firefox.html\">Privacy Policy<\/a>");
                document.writeln("<\/div>");
                //-->
            </script>
        </div>
    </div>

    <div id="download_beta" class="channel">
        <h3><span>Beta</span></h3>
        <ul class="channel-list">
            <li>Experience cutting edge features but with more stability</li>
            <li>Provide feedback to help refine and polish what will be in the final release</li>
        </ul>
    <div id="download-button">

    <script src="/js/download.old.js"></script>

<?php
// en-US download box is built in js and doesn't offer the flexibility
// hidePartialLocaleJS() hides unavailable locales for specific platforms
// include after download.old.js
hidePartialLocaleJS(LATEST_FIREFOX_DEVEL_VERSION);
?>
    <script>
          <!--
          // Configure the Firefox download write script
        if (gPlatform == 1) {
            document.body.className += ' platform-windows';
        } else if (gPlatform == 3 || gPlatform == 4) {
            document.body.className += ' platform-mac';
        } else if (gPlatform == 2) {
            document.body.className += ' platform-linux';
        }
          var gDownloadItemTemplate = " <li class=\"%CSS_CLASS%\"> <a onclick=\"javascript:do_download('%BOUNCER_URL%');\" href=\"%DOWNLOAD_URL%\" class=\"download-link\"> <span class=\"download-content\"><span class=\"download-title\">Download<\/span> Mozilla Firefox Beta<\/span><\/a> <\/li>";

      // Temporary fix for bug 439792
      if (gPlatform == PLATFORM_MACOSX) {
            gDownloadItemTemplate = " <li class=\"%CSS_CLASS%\"> <a onclick=\"javascript:do_download('%BOUNCER_URL%');\" href=\"%DOWNLOAD_URL%\" class=\"download-link\"> <span><strong>Free Download<\/strong> <em>%VERSION% for %PLATFORM_NAME% 10.5 and above</em> <em>%LANGUAGE_NAME%<\/em><\/span><\/a> <\/li>";
      }

          var gDownloadItemMacOS9 = "<a href=\"\">MacOS 9 and earlier are not supported<\/a>";
          var gDownloadItemOtherPlatform = "<a href=\"/<?=$lang?>/firefox/<?=LATEST_FIREFOX_DEVEL_VERSION?>/releasenotes/#contributedbuilds\">Free Download<\/a>"

          document.writeln("<ul class=\"home-download download-firefox " + gCssClass + " \">");
          writeDownloadItems("fxbeta");
          document.writeln("<\/ul>");
          document.writeln("<div class=\"download-other\"><span class=\"other\">");
          document.writeln("<a href=\"\/<?=$lang?>\/firefox\/all-beta.html\">All Systems &amp; Languages<\/a> - ");
          document.writeln("<a href=\"\/<?=$lang?>\/legal\/privacy\/firefox.html\">Privacy Policy<\/a>");
          document.writeln("<\/span><\/div>");

          //-->

    </script>

    <?php echo $firefoxDetails->getNoScriptBlockForLocale('en-US', array('devel_version' => true)); ?>

  </div>
    </div>

    <div id="download_mobile_beta" class="channel">
        <h3><span>Beta <span>for Mobile</span></span></h3>
        <ul class="channel-list">
            <li>Experience cutting edge mobile features still in development</li>
            <li>Provide feedback to help refine and polish what will be in the final release</li>
        </ul>
        <div class="home-download">
            <a href="https://market.android.com/details?id=org.mozilla.firefox" class="download-link download-firefox">
                <span class="download-content">
                <span class="download-title">Download</span>
                Mozilla Firefox Beta for Mobile
                </span>
            </a>
            <div class="download-other"><a href="/<?=$lang?>/mobile/platforms/">Supported devices</a>  | 
<a href="/<?=$lang?>/legal/privacy/firefox.html">Privacy Policy</a></div>
        </div>
    </div>

    <div id="channel_news" class="<?= $status ?>">
          <div id="newsletter-signup">
            <div class="title">
              <h3>Get the latest <span>channel news</span></h3>
              <p>Sign up for one or all of our Firefox channel newsletters.</p>
            </div>
            <div class="success-pane">
              <h3>Thanks for subscribing!</h3>
            </div>
            <form id="email-form" action="#newsletter-signup" method="post">
              <input id="email" name="email" type="email" value="<?= $form->get('email') ?>" placeholder="Your email address">
              <div id="email-error">Whoops! Be sure to enter a valid email address.</div>
              <div class="more">
                <div class="row">
                  <select id="country" name="country">
                      <option value="">Select country</option>
                      <?php
                          $country = $form->get('country');
                          if (!$country) {
                              $country = 'us';
                          }
                          echo regionsAsOptions($lang, $country);
                      ?>
                  </select>
                </div>
                <ul class="channels_signup">
                  <li>
                    <label for="check_aurora">
                        <input type="checkbox" id="check_aurora" name="aurora" value="t" />
                        <span>Aurora <small>(Desktop)</small></span>
                    </label>
                  </li>
                  <li>
                    <label for="check_beta">
                        <input type="checkbox" id="check_beta" name="beta" value="t" />
                        <span>Beta <small>(Desktop &amp; Mobile)</small></span>
                    </label>
                  </li>
                  <li>
                    <label for="check_general">
                        <input type="checkbox" id="check_general" name="general" value="t" />
                        <span>Final Release <small>(General Mozilla News)</small></span>
                    </label>
                  </li>
                </ul>
                <div id="channel-error">Please select at least one newsletter.</div>
                <div class="privacy-field">
                  <?php $checked = $form->get('privacy') ? 'checked="checked"' : '' ?>
                  <label for="inline-privacy-check" class="privacy-check-label">
                    <span class="error-wrapper"><input type="checkbox" class="privacy-check" id="inline-privacy-check" name="privacy" <?= $checked ?>></span> <span class="title">I agree to the <a href="/en-US/privacy-policy">Privacy Policy</a></span>
                  </label>
                </div>
                <input name="submit" class="button" type="submit" value="Sign me up!" id="subscribe"
                       onclick="dcsMultiTrack('DCS.dcssip', 'www.mozilla.com',
                                'DCS.dcsuri', '/mainstream_newsletter/signup',
                                'WT.ti', 'Link: Sign me up - Second Step',
                                'WT.dl', 99,
                                'WT.nv', 'Content',
                                'WT.ac', 'Newsletter');">
                <p class="footnote">We will only send you Mozilla-related information.</p>
              </div>
            </form>
          </div>

        <div id="blog">
            <h3>Follow the <span>Future Release Blog</span></h3>
            <p>Be the first to know what’s happening with <a href="http://blog.mozilla.com/futurereleases/">our upcoming releases</a>.</p>
            <?php

            require_once $config['file_root'].'/includes/Cache/Lite.php';

            $uri = 'http://blog.mozilla.com/futurereleases/feed/';
            $max_items = 4;
            $lifetime = 450; // 7.5 mins, about half static cache time

            $document = new DOMDocument();
            $items = array();

            $cache = new Cache_Lite(
                array(
                    'cacheDir' => dirname(__FILE__) . '/../../../cache/',
                    'lifeTime' => $lifetime,
                )
            );

            if (($xml = $cache->get($uri)) === false) {
                $xml = file_get_contents($uri);
                if ($xml === false) {
                    // try invalid cached version if it exists
                    if (($xml = $cache->get($uri, 'default', true)) === false) {
                        $xml = '';
                    }
                } else {
                    $cache->save($xml, $uri);
                }
            }

            if ($xml != '') {
                $document->loadXML($xml);
                $xpath = new DOMXPath($document);
                $item_els = $xpath->query('//item');
                $count = 0;
                foreach ($item_els as $item_el) {
                    $item = array();
                    $item['title'] = $xpath->evaluate('string(title/text())', $item_el);
                    $item['link'] = $xpath->evaluate('string(link/text())', $item_el);
                    $item['date'] = strtotime($xpath->evaluate('string(pubDate/text())', $item_el));
                    $categories = array();
                    $category_els = $xpath->query('category/text()', $item_el);
                    foreach ($category_els as $category) {
                        $categories[] = $category->data;
                    }
                    $item['categories'] = $categories;
                    $items[] = $item;
                    $count++;

                    if ($count >= $max_items) {
                        break;
                    }
                }
            }

            if (count($items) > 0) {
                echo '<ul>';

                foreach ($items as $item) {
                    echo '<li>';
                    echo '<h4><a href="' . htmlspecialchars($item['link']) . '">';
                    echo htmlspecialchars($item['title']);
                    echo '</a></h4>';
                    echo '<div class="info">';
                    echo '<span class="date">' . htmlspecialchars(date('F j, Y', $item['date'])) . '</span>';
                    if (count($item['categories']) > 0) {
                        echo ' • ';
                        $categories = array_map('htmlspecialchars', $item['categories']);
                        echo implode(', ', $categories);
                    }
                    echo '</div>';
                    echo '</li>';
                }

                echo '</ul>';
            }

            ?>
        </div>

    </div>

</div><!-- end #main-content div -->

<?php
    @include_once "{$config['file_root']}/{$lang}/includes/footer.inc.php";
?>
