<?php

// for sending sms and for list of countries + country codes
require_once "{$config['file_root']}/includes/mobile-sms.inc.php";

/**
 * Ajax processor for the SMS download link.
 */

class MozillaMobileSMSForm
{
    public static $lang = 'en-US';
    public static $config = array();

	public static function process()
	{
		if (!isset($_POST['mobile-post'])) {
			self::redirect();
		}

		$response = array(
			'errors' => array()
		);

		// sanitize and validate phone number
		if (!isset($_POST['mobile-phone']) || !isset($_POST['mobile-prefix'])) {
			$response['errors'][] = 'phone-required';
		}

        $phone  = self::sanitizePhone(
			$_POST['mobile-prefix'],
			$_POST['mobile-phone']
		);

		if ($phone === null) {
			$response['errors'][] = 'phone-required';
		}

		// validate captcha
		$response = array_merge_recursive($response, self::verifyRecaptcha());

		// send message
		if (count($response['errors']) === 0) {
			if (!self::sendDownloadSMS($phone, self::getMessage())) {
				$response['errors'][] = 'phone-error';
			}
		}

		return $response;
	}

	protected static function redirect()
	{
		$location = dirname($_SERVER['SCRIPT_URI']) . '/';
		header('Location: ' . $location);
		exit();
	}

	protected static function verifyRecaptcha()
	{
		$errors = array();

		// make sure required captcha fields are present
		if (!isset($_POST['recaptcha_challenge_field'])) {
			$errors[] = 'recaptcha-required';
		} elseif (!isset($_POST['recaptcha_response_field'])) {
			$errors[] = 'recaptcha-required';
		} elseif (!isset(self::$config['recaptcha_priv_key'])) {
			$errors[] = 'recaptcha-error';
		} elseif (!isset(self::$config['recaptcha_pub_key'])) {
			$errors[] = 'recaptcha-error';
		} else {
			// verify captcha response
			$recaptcha_verify_uri = 'http://www.google.com/recaptcha/api/verify';

			$data = http_build_query(
				array(
					'privatekey' => self::$config['recaptcha_priv_key'],
					'publickey'  => self::$config['recaptcha_pub_key'],
					'challenge'  => $_POST['recaptcha_challenge_field'],
					'response'   => $_POST['recaptcha_response_field'],
				),
				'data',
				'&'
			);

			$params = array(
				'http' => array(
					'method'  => 'POST',
					'content' => $data,
					'header'  => 'Content-Type: application/x-www-form-urlencoded',
				)
			);

			$context = stream_context_create($params);

			$fp = fopen($recaptcha_verify_uri, 'rb', false, $context);
			if ($fp !== false) {
				$response = stream_get_contents($fp);
				fclose($fp);
			} else {
				$response = 'false';
			}

			if (trim(reset(explode("\n", $response))) != 'true') {
				$errors[] = 'recaptcha-failed';
			}
		}

		return array(
			'errors' => $errors,
		);
	}

    protected static function sanitizePhone($prefix, $phone)
	{
        $phone  = preg_replace('/[^\+0-9]/', '', $phone);
        $prefix = preg_replace('/[^\+0-9]/', '', $prefix);

        if ($phone == '' || str_replace($prefix, '', $phone) == '') {
			$phone = null;
		} elseif (strpos($phone, $prefix) !== 0) {
			// this means either JS is off or the user intervened to remove the
			// prefix so we'll add it back
            $phone = $prefix . $phone;
		}

        return $phone;
    }

	protected static function sendDownloadSMS($phone, $message)
	{
		$success = false;

        try  {
            $si = new SmsInterface(false, false);
            $si->addMessage($phone, $message);

			$connected = $si->connect(
				self::$config['sms_username'],
				self::$config['sms_password'],
				true,
				false
			);

            if ($connected && $si->sendMessages()) {
				$success = true;
			}
        } catch (Exception $e) {
        }

		return $success;
	}

    protected static function getMessage()
	{
		$message = array_key_exists(self::$lang, sms::$messages) ?
			sms::$messages[self::$lang] :
			sms::$messages['en-US'];

		$message .= ' '. mobileDetails::download_url(
			self::$lang,
			mobileDetails::maemo
		);

		return $message;
	}
}

MozillaMobileSMSForm::$config = $config;
MozillaMobileSMSForm::$lang   = $lang;

echo json_encode(MozillaMobileSMSForm::process());

?>
